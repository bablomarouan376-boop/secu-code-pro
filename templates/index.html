<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecuCode Pro | Elite Security Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background: #020617; color: #f8fafc; }
        .cyber-card { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(16px); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 24px; }
        .glow-button { transition: 0.3s; box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }
        .glow-button:hover { box-shadow: 0 0 25px rgba(59, 130, 246, 0.6); transform: translateY(-2px); }
        .status-badge { padding: 4px 12px; border-radius: 100px; font-size: 10px; font-weight: bold; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>
<body class="antialiased">

    <nav class="max-w-6xl mx-auto p-6 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/50">
                <i data-lucide="shield-check" class="text-white"></i>
            </div>
            <h1 class="text-2xl font-black tracking-tighter">SECUCODE <span class="text-blue-500">PRO</span></h1>
        </div>
        <div class="flex gap-4">
            <button onclick="showModal('about')" class="text-xs text-gray-400 hover:text-white transition">حول النظام</button>
            <button onclick="showModal('privacy')" class="text-xs text-gray-400 hover:text-white transition">الخصوصية</button>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-6 grid grid-cols-1 lg:grid-cols-12 gap-8 py-8">
        
        <div class="lg:col-span-8 space-y-8">
            <div class="cyber-card p-8 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-600 to-cyan-400"></div>
                <h2 class="text-2xl font-bold mb-6">مركز الفحص الذكي</h2>
                
                <div class="flex flex-col md:flex-row gap-4">
                    <input type="text" id="urlInput" placeholder="أدخل الرابط المراد تحليله..." 
                           class="flex-1 bg-slate-900/50 border border-slate-700 p-4 rounded-2xl outline-none focus:border-blue-500 transition font-mono text-sm">
                    <button onclick="startScan()" id="scanBtn" class="glow-button bg-blue-600 px-8 py-4 rounded-2xl font-bold flex items-center justify-center gap-2">
                        <span>ابدأ الفحص</span>
                        <i data-lucide="zap" class="w-4 h-4"></i>
                    </button>
                </div>

                <div id="resultArea" class="hidden mt-8 p-6 rounded-2xl bg-slate-900/40 border border-slate-800 animate-in fade-in zoom-in duration-300">
                    <div class="flex flex-col md:flex-row justify-between items-start gap-6">
                        <div class="space-y-4 flex-1">
                            <div id="statusTag"></div>
                            <h3 id="resultUrl" class="font-mono text-sm break-all text-blue-400"></h3>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="bg-slate-800/50 p-3 rounded-xl text-center">
                                    <p class="text-[10px] text-gray-500">مشبوه</p>
                                    <p id="resMal" class="font-bold text-red-500">0</p>
                                </div>
                                <div class="bg-slate-800/50 p-3 rounded-xl text-center">
                                    <p class="text-[10px] text-gray-500">آمن</p>
                                    <p id="resSafe" class="font-bold text-green-500">0</p>
                                </div>
                                <div class="bg-slate-800/50 p-3 rounded-xl text-center">
                                    <p class="text-[10px] text-gray-500">غير مكتشف</p>
                                    <p id="resUnd" class="font-bold text-gray-400">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-3 rounded-2xl" id="qrcode"></div>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="font-bold flex items-center gap-2"><i data-lucide="history" class="w-5 h-5"></i> آخر العمليات</h3>
                <div id="historyList" class="space-y-3">
                    </div>
            </div>
        </div>

        <div class="lg:col-span-4 space-y-6">
            <div class="cyber-card p-6">
                <h3 class="text-sm font-bold text-gray-400 mb-6 uppercase tracking-widest">إحصائيات النظام المباشرة</h3>
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-blue-500/10 rounded-lg text-blue-500"><i data-lucide="globe"></i></div>
                            <span class="text-sm">إجمالي الفحوصات</span>
                        </div>
                        <span id="totalScans" class="font-mono font-bold text-xl">0</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-red-500/10 rounded-lg text-red-500"><i data-lucide="skull"></i></div>
                            <span class="text-sm">روابط ضارة مكتشفة</span>
                        </div>
                        <span id="malScans" class="font-mono font-bold text-xl text-red-500">0</span>
                    </div>
                </div>
            </div>

            <div class="cyber-card p-6 bg-gradient-to-br from-blue-600/20 to-transparent border-none">
                <h4 class="font-bold mb-2">نصيحة أمنية</h4>
                <p class="text-xs text-gray-400 leading-relaxed">لا تقم أبداً بإدخال بياناتك البنكية في روابط تصلك عبر رسائل SMS غير معروفة، حتى لو كان الموقع يبدو حقيقياً.</p>
            </div>
        </div>
    </main>

    <div id="modal" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="cyber-card max-w-lg w-full p-8 relative">
            <button onclick="hideModal()" class="absolute top-4 left-4 text-gray-500 hover:text-white"><i data-lucide="x"></i></button>
            <div id="modalContent" class="prose prose-invert"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://secucode-pro-default-rtdb.firebaseio.com/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const userId = localStorage.getItem('userId') || 'u_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', userId);

        lucide.createIcons();

        // تحديث العدادات المباشرة
        onValue(ref(db, 'stats'), (snap) => {
            const data = snap.val() || {};
            document.getElementById('totalScans').innerText = data.total_scans || 0;
            document.getElementById('malScans').innerText = data.malicious_found || 0;
        });

        window.startScan = async function() {
            const url = document.getElementById('urlInput').value.trim();
            if(!url) return;

            const btn = document.getElementById('scanBtn');
            btn.disabled = true;
            btn.innerHTML = `<span class="animate-spin">⏳</span>`;

            try {
                const res = await fetch('/scan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url: url, user_id: userId })
                });
                const result = await res.json();
                
                // عرض النتائج
                document.getElementById('resultArea').classList.remove('hidden');
                document.getElementById('resultUrl').innerText = url;
                document.getElementById('resMal').innerText = result.data.malicious;
                document.getElementById('resSafe').innerText = result.data.harmless;
                document.getElementById('resUnd').innerText = result.data.undetected;

                const tag = document.getElementById('statusTag');
                if(result.risk === 'safe') {
                    tag.innerHTML = `<span class="status-badge bg-green-500/20 text-green-500">آمن تماماً</span>`;
                } else {
                    tag.innerHTML = `<span class="status-badge bg-red-500/20 text-red-500">خطر محتمل</span>`;
                }

                // توليد QR Code
                document.getElementById('qrcode').innerHTML = '';
                new QRCode(document.getElementById("qrcode"), { text: url, width: 100, height: 100 });

                loadHistory();
            } catch (e) {
                alert("خطأ في الخادم");
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<span>ابدأ الفحص</span> <i data-lucide="zap" class="w-4 h-4"></i>`;
                lucide.createIcons();
            }
        };

        async function loadHistory() {
            const res = await fetch('/history/' + userId);
            const data = await res.json();
            const list = document.getElementById('historyList');
            list.innerHTML = data.map(item => `
                <div class="bg-slate-900/40 p-4 rounded-2xl flex justify-between items-center border border-slate-800">
                    <div class="flex items-center gap-4 truncate">
                        <div class="w-2 h-2 rounded-full ${item.status === 'safe' ? 'bg-green-500 shadow-[0_0_8px_#22c55e]' : 'bg-red-500 shadow-[0_0_8px_#ef4444]'}"></div>
                        <span class="font-mono text-xs truncate max-w-[200px] md:max-w-md">${item.url}</span>
                    </div>
                    <span class="text-[10px] text-gray-500">${new Date(item.timestamp * 1000).toLocaleTimeString('ar-EG')}</span>
                </div>
            `).join('');
        }
        loadHistory();

        // Modals Logic
        window.showModal = (type) => {
            const content = {
                about: `<h2 class="text-blue-500">حول SecuCode Pro</h2><p>نظام متطور يعتمد على تقنيات VirusTotal للتحليل العميق للروابط. تم تطوير النظام بواسطة طارق مصطفى ليكون خط الدفاع الأول ضد التصيد الاحتيالي.</p>`,
                privacy: `<h2 class="text-blue-500">سياسة الخصوصية</h2><p>نحن لا نقوم بتخزين أي بيانات شخصية. الروابط التي يتم فحصها تُستخدم فقط لتحسين قاعدة بيانات التهديدات العامة وتنبيهك في حال وجود خطر.</p>`
            };
            document.getElementById('modalContent').innerHTML = content[type];
            document.getElementById('modal').classList.remove('hidden');
        };
        window.hideModal = () => document.getElementById('modal').classList.add('hidden');
    </script>
</body>
</html>
